from rest_framework import serializers
from django.contrib.auth import get_user_model


# ìœ ì € ì‹œë¦¬ì–¼ ë¼ì´ì €
# UserSerializerëŠ” ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì˜ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ê±°ë‚˜, JSON ë°ì´í„°ë¥¼ ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³€í™˜í•˜ëŠ” ì—­í• ì„ í•œë‹¤.
class UserSerializer(serializers.ModelSerializer):
    '''
    í˜„ì¬ ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì— ì´ë¯¸ì§€ í•„ë“œë„ ìˆëŠ”ë°, ê·¸ í•„ë“œì˜ ì§ë ¬í™”ëŠ” ì–´ë–»ê²Œ ì´ë£¨ì–´ì§€ëŠ”ê°€?
    â¡ï¸
    ImageFieldëŠ” ì´ë¯¸ì§€ íŒŒì¼ 'ê²½ë¡œ'(ì‹¤ì œ íŒŒì¼ì´ ì„œë²„ì— ì €ì¥ëœ ìœ„ì¹˜ : íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì„œë²„ ì¸¡ì—ì„œ í•´ë‹¹ ê²½ë¡œë¥¼ í†µí•´ ì§ì ‘ íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ê²½ìš°ì— ì‚¬ìš©)ë¥¼ ì§ë ¬í™”í•œë‹¤. 
    ë§Œì•½ ì´ í•„ë“œë¥¼ í¬í•¨í•˜ì—¬ JSON ì‘ë‹µì—ì„œ ì´ë¯¸ì§€ë¥¼ ë³´ì—¬ì£¼ë ¤ë©´ MEDIA_URLì„ ì¶”ê°€í•˜ëŠ” ë“±ì˜ ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤. 
    ì˜ˆë¥¼ ë“¤ì–´, profile_imageê°€ ì´ë¯¸ì§€ URL(ì‚¬ìš©ìê°€ ì›¹ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ì´ë¯¸ì§€ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë§í¬)ë¡œ ì§ë ¬í™”ë˜ë„ë¡ í•˜ë ¤ë©´, to_representation ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ URLì„ ë°˜í™˜í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
    (ì›¹ì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì œê³µí•˜ê³  ì‹¶ë‹¤ë©´, ì´ë¯¸ì§€ URLë¡œ ì§ë ¬í™”í•˜ëŠ” ê²ƒì´ ë” ì í•©í•˜ë‹¤ëŠ” ì .)
    ì‹¤ë¬´ì—ì„œëŠ” ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ì§€ì— ì‰½ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì´ë¯¸ì§€ url ê²½ë¡œë¥¼ ë§ì´ ì‚¬ìš©í•œë‹¤.
    (DjangoëŠ” MEDIA_URLê³¼ MEDIA_ROOT ì„¤ì •ì„ í†µí•´ íŒŒì¼ ì„œë²„ì™€ ì—°ë™í•˜ì—¬, ì´ë¯¸ì§€ íŒŒì¼ì˜ ê²½ë¡œì™€ ë„ë©”ì¸ì„ í•©ì¹œ ì™„ì „í•œ URLì„ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤Œ)
    '''
    # ì„¤ì • ì •ë³´ë¥¼ ì •ì˜í•˜ê¸° ìœ„í•œ ë‚´ë¶€ í´ë˜ìŠ¤
    class Meta:
        # ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì„ ì‹œë¦¬ì–¼ë¼ì´ì¦ˆ(ì§ë ¬í™”)í•˜ê² ë‹¤.
        # í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œ ì •ì˜ëœ User ëª¨ë¸ ì‚¬ìš©
        model = get_user_model()
        # ëª¨ë¸ ì¤‘ì—ì„œ ì–´ë–¤ í•„ë“œë¥¼ ì§ë ¬í™”í•  ê±´ë°?
        # ëª¨ë“  í•„ë“œë¥¼. (í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ í¬í•¨í•œ ëª¨ë“  í•„ë“œê°€ ì§ë ¬í™”ëœë‹¤.)
        fields = "__all__"
        
        # ì´ë¯¸ì§€ í•„ë“œë¥¼ ì´ë¯¸ì§€ url ë¡œ ì§ë ¬í™” ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë°©ë²•
        # ê¸°ë³¸ to_representation ë©”ì„œë“œëŠ” ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì§ë ¬í™”í•˜ì—¬ Python ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë°˜í™˜
        # ì´ ë©”ì„œë“œì˜ ì˜¤ë²„ë¼ì´ë“œë¥¼ í†µí•´ ì§ë ¬í™” ê³¼ì •ì—ì„œ íŠ¹ì • í•„ë“œë¥¼ ì–´ë–»ê²Œ ë³€í™˜í• ì§€ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ ìˆë‹¤.
        def to_representation(self, instance):
            '''
            to_representation ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬, ì´ë¯¸ì§€ í•„ë“œë¥¼ íŒŒì¼ ê²½ë¡œì—ì„œ ì´ë¯¸ì§€ URLë¡œ ë³€í™˜í•˜ëŠ” ì²˜ë¦¬. 
            ì´ ë°©ë²•ì„ í†µí•´ ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œê°€ ì•„ë‹Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ URLë¡œ ë°˜í™˜ë˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.
            '''
            
            # super()ëŠ” ë¶€ëª¨ í´ë˜ìŠ¤ì¸ ModelSerializerì˜ to_representation ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œ
            # ê¸°ë³¸ ì§ë ¬í™”ëœ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì½”ë“œ
            representation = super().to_representation(instance)
            
            # profile_image í•„ë“œê°€ ë¹„ì–´ ìˆì§€ ì•Šë‹¤ë©´
            if instance.profile_image:
                # 'profile_image' í•„ë“œë¥¼ ê²½ë¡œì—ì„œ URLë¡œ ë³€í™˜
                # instance.profile_image.urlì€ ì´ë¯¸ì§€ íŒŒì¼ì˜ ì ˆëŒ€ URLì„ ë°˜í™˜
                # ì´ URLì„ ì§ë ¬í™”ëœ ê²°ê³¼ ë”•ì…”ë„ˆë¦¬ representationì— profile_image í‚¤ì˜ value ê°’ìœ¼ë¡œ ë„£ì–´ì¤Œ. ê¸°ì¡´ ê±° ëŒ€ì²´.
                representation['profile_image'] = instance.profile_image.url  # ì´ë¯¸ì§€ URLë¡œ ë³€í™˜
            
            # ë³€í™˜ëœ URLì„ ì§ë ¬í™”ëœ ë°ì´í„°ì— ë°˜ì˜í•˜ì—¬, í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬ë˜ëŠ” JSON ì‘ë‹µì— ì´ë¯¸ì§€ URLì´ í¬í•¨ëœë‹¤.
            return representation
        
        
# â­ï¸ íšŒì›ê°€ì… ì‹œë¦¬ì–¼ë¼ì´ì € 
class UserCreationSerializer(serializers.ModelSerializer):
    # ì§€ê¸ˆ ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì—ëŠ” íŒ¨ìŠ¤ì›Œë“œë¥¼ ë°›ëŠ” í•„ë“œê°€ ì—†ìŒ!
    # íšŒì›ê°€ì… ì‹œ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ë“œë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ ì¶”ê°€. (í¼ì—ì„œ form.CharField í–ˆë˜ ê²ƒì²˜ëŸ¼, ì—­ì‹œë‚˜ ì‹œë¦¬ì–¼ë¼ì´ì €ë„ ë™ì¼í•˜ê²Œ ì§„í–‰í•œë‹¤.)
    # write_only=True: ì‘ë‹µ ë°ì´í„°(JSON)ì—ì„œëŠ” ì´ í•„ë“œê°€ í¬í•¨ë˜ì§€ ì•ŠìŒ. (ì…ë ¥ë°›ëŠ” ìš©ë„ë¡œë§Œ ì‚¬ìš©)
    password = serializers.CharField(write_only=True, required=True, style={'input_type': 'password'})
    password2 = serializers.CharField(write_only=True, required=True, style={'input_type': 'password'})
    
    class Meta:
        '''
        í´ë¼ì´ì–¸íŠ¸ê°€ JSON í˜•ì‹ìœ¼ë¡œ POST ìš”ì²­ì„ ë³´ë‚´ëŠ” ì˜ˆì‹œ..ëŠ” ì´ë¯¸ì§€ í•„ë“œê°€ í¬í•¨ë  ê²½ìš° ì—„ì²­ ë³µì¡í•˜ê¸¸ë˜ ì•ˆ ë„£ì—ˆìŒ
        ì–´ì¨Œë“  ëŒ€ì¶© 'username', 'email', 'password', 'password2', 'profile_image' ì–˜ë„¤ë¥¼ ë³´ë‚¼ ê±°ì„
        '''
        # ì§ë ¬í™” ëŒ€ìƒ ëª¨ë¸
        model = get_user_model()
        # ì§ë ¬í™”í•  í•„ë“œ. ìœ ì € ëª¨ë¸ì—ì„œ íšŒì›ê°€ì…ì— í•„ìš”í•œ í•„ë“œë§Œ ì§€ì •
        # ğŸ’¡ fieldsì— ì§€ì •í•˜ì§€ ì•Šì€ í•„ë“œë¥¼ í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚´ë©´, DRFëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì§ë ¬í™” ì‹œ í•´ë‹¹ í•„ë“œë¥¼ ë¬´ì‹œí•œë‹¤. ì¦‰, í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì— í¬í•¨ì‹œí‚¨ ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ì‹œë¦¬ì–¼ë¼ì´ì €ì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•Šê³ , ê·¸ ê°’ì€ ì§ë ¬í™” ê³¼ì •ì—ì„œ ì œì™¸ëœë‹¤.
        # fieldsì— ì •ì˜ë˜ì§€ ì•Šì€ í•„ë“œëŠ” ì§ë ¬í™” ë° ìœ íš¨ì„± ê²€ì‚¬ ê³¼ì •ì—ì„œ ì œì™¸ë˜ë©°, ë”°ë¼ì„œ ì €ì¥(save) ê³¼ì •ì—ë„ í¬í•¨ë˜ì§€ ì•ŠëŠ”ë‹¤.
        fields = ['username', 'email', 'password', 'password2', 'profile_image']
    
    
    # ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    def validate(self, data):
        '''
        dataëŠ” serializerì— ì „ë‹¬ëœ í´ë¼ì´ì–¸íŠ¸ ë°ì´í„°ë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ ì²˜ë¦¬í•œ ê²°ê³¼.
        validate ë©”ì„œë“œëŠ” ì´ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ê°€ ê²€ì¦ì„ ìˆ˜í–‰.
        
        ì‹œë¦¬ì–¼ë¼ì´ì €ê°€ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ dataì—ëŠ” ì²˜ìŒì—ëŠ” request.data ê°€ ë‹´ê²¼ë‹¤ê°€, ì‹œë¦¬ì–¼ë¼ì´ì €ê°€ í•„ë“œë³„ë¡œ ìœ íš¨ì„±ì„ ê²€ì¦í•œ í›„ì˜ ë°ì´í„°ê°€ ë‹´ê²¨ìˆë‹¤. 
        ì›ë˜ ì‹œë¦¬ì–¼ë¼ì´ì € ìì²´ì ìœ¼ë¡œ í•„ë“œë³„ ìœ íš¨ì„± ê²€ì‚¬ > validate() ë©”ì„œë“œ í˜¸ì¶œ ìˆœì„œëŒ€ë¡œ ì§„í–‰ëœë‹¤.
        
        ê¸°ë³¸ê²€ì¦ ë¡œì§ë§Œ ìˆë“ , ì¶”ê°€ ê²€ì¦ ë¡œì§ê¹Œì§€ ìˆë“ , ì •ì˜í•´ë†“ì€ ìœ íš¨ì„± ë¡œì§ì„ ëª¨ë‘ ê±°ì¹˜ë©´ serializer.validated_dataì— ê²€ì¦ëœ ë°ì´í„°ê°€ ì €ì¥ë¨!
        '''
        # ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ê°™ì§€ ì•Šìœ¼ë©´
        if data['password'] != data['password2']:
            # ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¤ê¸°
            raise serializers.ValidationError("Passwords do not match.")
        # ìœ íš¨í•˜ë‹¤ë©´ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜
        # ğŸ’¡ ì´ ë°˜í™˜ëœ ë°ì´í„°ëŠ” serializer.validated_dataì— ì €ì¥ëœë‹¤! ì´ê²Œ ì´ì œ ë°”ë¡œ ë°‘ì˜ create ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê±°ì„.
        return data


    def create(self, validated_data):
        # password2ëŠ” ìœ ì € ëª¨ë¸ì— ì €ì¥í•˜ì§€ ì•Šì•„ì•¼ í•¨ (ë°ì´í„°ì˜ ëì— íŒ¨ìŠ¤ì›Œë“œ2 ìˆì„í…Œë‹ˆê¹Œ popìœ¼ë¡œ validated_dataì—ì„œ ë‚ ë ¤ë²„ë¦¼)
        validated_data.pop('password2')
        # create_user()ë¥¼ ì‚¬ìš©í•˜ë©´, ìœ ì €ì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ìë™ìœ¼ë¡œ í•´ì‹œë˜ì–´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœë‹¤. ì´ë ‡ê²Œ í•´ì‹œ ì²˜ë¦¬ëœ ë¹„ë°€ë²ˆí˜¸ëŠ” ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ë©°, í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ëŠ” ì €ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤.
        # create() ë©”ì„œë“œëŠ” user ê°ì²´ë¥¼ ìƒì„±í•œ í›„, í•´ë‹¹ user ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.
        user = get_user_model().objects.create_user(**validated_data)
        # create ë©”ì„œë“œê°€ ì›ë˜ DBì— ì¸ìŠ¤í„´ìŠ¤ ìƒì„±í•˜ê³  ê·¸ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œì„. ê¸°ë³¸ create ë©”ì„œë“œ ëŒ€ì²´í•˜ëŠ” ê±°ë‹ˆê¹Œ ë¡œì§ ë˜‘ê°™ì´ ë§Œë“¤ì–´ì£¼ì ~
        return user

    # ëª¨ë“  ë¡œì§ì„ ìˆ˜í–‰í•˜ê³  ìµœì¢…ì ìœ¼ë¡œ ì´ ì‹œë¦¬ì–¼ë¼ì´ì €ê°€ ë°˜í™˜í•  ë‚´ìš©. ì´ê²ƒì´ serializer.data ì— ì €ì¥ë˜ëŠ” ë‚´ìš©ì´ë‹¤! (ë¬¼ë¡  ì´ ì‹œë¦¬ì–¼ë¼ì´ì € ì‚¬ìš©í•˜ëŠ” ë·°ì—ì„  ì´ê±° ì•ˆ ì‚¬ìš©í•˜ê¸´ í•¨)
    def to_representation(self, instance):
        # ê¸°ë³¸ ì§ë ¬í™” ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
        representation = super().to_representation(instance)
        if instance.profile_image:
            # ì´ë¯¸ì§€ í•„ë“œë¥¼ URLë¡œ ë³€í™˜
            representation['profile_image'] = instance.profile_image.url
        return representation